apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: rabbitmq
  namespace: argocd
spec:
  project: default
  source:
    chart: rabbitmq
    repoURL: registry-1.docker.io/bitnamicharts
    targetRevision: 15.1.0
    helm:
      values: |-
        image:
          registry: docker.io
          repository: bitnami/rabbitmq
          tag: 3.13.0-debian-12-r0

        auth:
          username: admin_user
          existingPasswordSecret: rabbitmq-credentials
          existingPasswordSecretPasswordKey: password

        # Enable management plugin
        containerPorts:
          http: 15672

        extraConfiguration: |-
          management.load_definitions = /app/load_definition.json

        extraVolumes:
          - name: definitions
            configMap:
              name: rabbitmq-definitions

        extraVolumeMounts:
          - name: definitions
            mountPath: /app/load_definition.json
            subPath: definitions.json

        # Configure service for Traefik
        service:
          type: ClusterIP
          ports:
            http: 15672  # Management UI port
          annotations: {}

        # Configure Traefik IngressRoute for local Kind cluster
        ingress:
          enabled: true
          hostname: rabbitmq.localhost
          path: /
          ingressClassName: traefik
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: web
            traefik.ingress.kubernetes.io/router.middlewares: rabbitmq-stripprefix@kubernetescrd
          tls: false

        # Add middleware to handle path stripping for Traefik v3
        extraDeploy:
          - apiVersion: traefik.io/v1alpha1
            kind: Middleware
            metadata:
              name: rabbitmq-stripprefix
              namespace: rabbitmq
            spec:
              stripPrefix:
                prefixes:
                  - /rabbitmq
                  - /

  destination:
    namespace: rabbitmq
    name: in-cluster
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
